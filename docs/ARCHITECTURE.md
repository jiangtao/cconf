# 架构设计

## 概述

ccconfig 采用模块化设计，将不同功能分离到独立的包中。

## 核心组件

```
┌─────────────────────────────────────────────────────────┐
│                         CLI Layer                        │
│  (cmd/)                                                 │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐      │
│  │ backup  │ │ restore │ │  cache  │ │  init   │      │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘      │
│       │           │           │           │             │
└───────┼───────────┼───────────┼───────────┼─────────────┘
        │           │           │           │
        ▼           ▼           ▼           ▼
┌─────────────────────────────────────────────────────────┐
│                      Business Layer                      │
│  (pkg/)                                                 │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐      │
│  │ backup/ │ │ restore/│ │ cache/  │ │  git/   │      │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘      │
│       │           │           │           │             │
└───────┼───────────┼───────────┼───────────┼─────────────┘
        │           │           │           │
        ▼           ▼           ▼           ▼
┌─────────────────────────────────────────────────────────┐
│                      Support Layer                       │
│  (pkg/)                                                 │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐      │
│  │ config/ │ │  i18n/  │ │   ui/   │ │         │      │
│  └─────────┘ └─────────┘ └─────────┘ │         │      │
│                                         │         │      │
└─────────────────────────────────────────┴─────────┘
```

## 包职责

### cmd/ - CLI 命令层

负责：
- 解析命令行参数
- 调用业务逻辑
- 处理用户交互

### pkg/backup/ - 备份业务逻辑

负责：
- Settings 备份（移除敏感信息）
- Commands 备份
- Skills 备份
- Projects 扫描和备份

### pkg/restore/ - 恢复业务逻辑

负责：
- Settings 恢复（合并 API Token）
- Commands 恢复
- Skills 恢复

### pkg/cache/ - 缓存管理

负责：
- 插件缓存打包（tar.gz）
- 缓存解压
- 缓存清理

### pkg/config/ - 配置管理

负责：
- 配置文件解析
- 环境变量处理
- 路径展开

### pkg/git/ - Git 操作

负责：
- Git 仓库初始化
- Add/Commit/Push 操作
- 状态检查

### pkg/i18n/ - 国际化

负责：
- 翻译文件加载
- 语言检测
- 文本本地化

### pkg/ui/ - 用户界面

负责：
- 彩色输出
- 消息格式化

## 数据流

### Backup 流程

```
User Input (CLI Flags)
         │
         ▼
┌─────────────────┐
│ Config Merge    │
│ (flag + file)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Validate Paths  │
└────────┬────────┘
         │
    ┌────┴────┐
    ▼         ▼
┌────────┐ ┌────────┐
│ Backup │ │ Backup │
│Settings│ │Commands│
└────┬───┘ └────┬───┘
     │          │
     └────┬─────┘
          ▼
    ┌────────┐
    │ Backup │
    │ Skills │
    └────┬───┘
         │
         ▼
    ┌────────┐
    │ Backup │
    │Projects│
    └────┬───┘
         │
         ▼
    ┌────────┐
    │Git Add │
    │&Commit │
    └────┬───┘
         │
         ▼
   ┌──────────┐
   │ Output   │
   └──────────┘
```

### Restore 流程

```
User Input (CLI Flags)
         │
         ▼
┌─────────────────┐
│ Config Merge    │
│ (flag + file)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Git Pull        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Create Dirs     │
└────────┬────────┘
         │
    ┌────┴────┐
    ▼         ▼
┌────────┐ ┌────────┐
│Restore │ │Restore │
│Settings│ │Commands│
└────┬───┘ └────┬───┘
     │          │
     └────┬─────┘
          ▼
    ┌────────┐
    │Restore │
    │ Skills │
    └────┬───┘
         │
         ▼
   ┌──────────┐
   │ Output   │
   └──────────┘
```

## 错误处理策略

| 错误类型 | 处理方式 | 示例 |
|---------|---------|------|
| 源文件不存在 | 警告，继续 | settings.json 缺失 |
| 目标无权限 | 错误，退出 | ~/.claude 不可写 |
| Git 失败 | 警告，继续 | git commit 失败 |
| JSON 解析失败 | 错误，退出 | settings.json 损坏 |
| Token 无效 | 警告，提示重输 | API Token 格式错误 |

## 扩展点

### 添加新的备份类型

1. 在 `pkg/backup/` 创建新文件
2. 实现 Backup 接口
3. 在 `cmd/backup.go` 中调用

### 添加新的语言

1. 在 `pkg/i18n/` 创建新的 YAML 文件
2. 添加翻译内容
3. 在 `i18n.go` 中注册语言

### 添加新的命令

1. 在 `cmd/` 创建新文件
2. 实现 cobra.Command
3. 在 `init()` 中注册
